<!DOCTYPE html>
<html>
<head>
    <title>Redeem Points</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    {% load static %}
	<link rel="stylesheet" href="{% static 'sustainability/style.css' %}">
</head>
<body onload="redeemPoints(1,1)"> <!-- Call the getUserLocation function when the page loads for finished product getUserLocation should be here -->
    <nav>
        <button data-url="{% url 'sustainability:leaderboard' %}" onclick="openUrl(this)">Leaderboard</button>
        <button data-url="{% url 'sustainability:auth' %}" onclick="openUrl(this)">Authentication</button>
        <button data-url="{% url 'sustainability:map' %}" onclick="openUrl(this)">Map</button>
        </nav>
    
        <script>
            function openUrl(button) {
                var url = button.getAttribute('data-url');
                window.location.href = url;
            }
        </script>
    <h1>Welcome to the Redeem Points Page</h1>
    <div id="redemption-message"></div>
    
    <script>
        // Get the buildingID and actionID from the URL
        function getUserLocation() {// Get the user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(checkPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function checkPosition(position) {// Check if the user is within the boundaries of the University of Exeter
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            // Check if the user is within the boundaries of the University of Exeter
            if (latitude >= 50.729 && latitude <= 50.744 && longitude >= -3.54 && longitude <= -3.5260) {
                // User is within the boundaries
                var buildingID = {buildingID};
                var actionID = {actionID};
                redeemPoints(buildingID, actionID);
              
                
            } else {
                // User is outside the boundaries
                alert("You are outside the boundaries of the University of Exeter therefore you cannot redeem points.");
                window.location.href = "/"; // Redirect to the home page
            }
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        function redeemPoints(buildingID, actionID) {
            //check if user is authenticated
            const userID = getCookie('userID');
            if (!userID) {
                window.location.href = '/login'; // Replace '/login' with the actual login page URL
            }          
            console.log(userID) 
            if (userID) {
                //send request to DB to retrieve the actions points and the building points and then add the points to the user and the teams building ranking
                $.ajax({
                    url: `/get-building-and-action-names/${buildingID}/${actionID}/`,
                    type: 'GET',
                    success: function(response) {
                        var buildingName = response.buildingName;
                        var actionName = response.actionName;
                        console.log('Building Name:', buildingName);
                        console.log('Action Name:', actionName);
                        var dateTimeEarned = new Date().toISOString();
                        var csrftoken = getCookie('csrftoken');
                        // AJAX request to write to the score table
                        $.ajax({
                            url: '/write-to-score-table/',
                            type: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            data: {
                                userID: userID,
                                buildingID: buildingID,
                                actionID: actionID,
                                dateTimeEarned: dateTimeEarned
                            },
                            success: function(response) {
                                // Handle success response
                                var redemptionMessage = "Congratulations! You have redeemed the action: " + response.actionName + " at the building: " + response.buildingName + " which earned you " + response.pointsValue + " points.";
                                $('#redemption-message').text(redemptionMessage);
                                console.log('Score written successfully:', response);
                            },
                            error: function(xhr, status, error){
                                // Handle error response
                                console.error('Error writing to score table:', error);
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
                
            }else {
                // Custom cookie does not exist, user is not logged in
                alert("Please log in to redeem points.");
                window.location.href = "/login"; // Redirect to the login page
            }
            
        }

    function getCookie(name) {
    const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return cookieValue ? cookieValue.pop() : '';
    }
    
    </script>
</body>
</html>
